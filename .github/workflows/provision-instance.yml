# HubbleWave Customer Instance Provisioning
# Triggered by Control Plane or manually to provision new customer instances

name: Provision Customer Instance

on:
  workflow_dispatch:
    inputs:
      customer_code:
        description: 'Customer code (e.g., acme-corp)'
        required: true
        type: string
      instance_id:
        description: 'Instance UUID'
        required: true
        type: string
      resource_tier:
        description: 'Resource tier'
        required: true
        type: choice
        options:
          - standard
          - professional
          - enterprise
        default: standard
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production
        default: staging

  repository_dispatch:
    types: [provision-instance]

env:
  TF_VAR_customer_code: ${{ github.event.inputs.customer_code || github.event.client_payload.customer_code }}
  TF_VAR_instance_id: ${{ github.event.inputs.instance_id || github.event.client_payload.instance_id }}
  TF_VAR_resource_tier: ${{ github.event.inputs.resource_tier || github.event.client_payload.resource_tier || 'standard' }}
  TF_VAR_environment: ${{ github.event.inputs.environment || github.event.client_payload.environment || 'staging' }}

jobs:
  validate:
    name: Validate Input
    runs-on: ubuntu-latest
    outputs:
      customer_code: ${{ steps.validate.outputs.customer_code }}
      instance_id: ${{ steps.validate.outputs.instance_id }}
      resource_tier: ${{ steps.validate.outputs.resource_tier }}
      environment: ${{ steps.validate.outputs.environment }}
    steps:
      - name: Validate inputs
        id: validate
        run: |
          # Validate customer code format
          if ! [[ "${{ env.TF_VAR_customer_code }}" =~ ^[a-z0-9][a-z0-9-]{2,30}[a-z0-9]$ ]]; then
            echo "Invalid customer_code format. Must be lowercase alphanumeric with hyphens, 4-32 chars."
            exit 1
          fi

          # Validate instance ID is a UUID
          if ! [[ "${{ env.TF_VAR_instance_id }}" =~ ^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$ ]]; then
            echo "Invalid instance_id format. Must be a valid UUID."
            exit 1
          fi

          echo "customer_code=${{ env.TF_VAR_customer_code }}" >> $GITHUB_OUTPUT
          echo "instance_id=${{ env.TF_VAR_instance_id }}" >> $GITHUB_OUTPUT
          echo "resource_tier=${{ env.TF_VAR_resource_tier }}" >> $GITHUB_OUTPUT
          echo "environment=${{ env.TF_VAR_environment }}" >> $GITHUB_OUTPUT

  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: validate
    environment: ${{ needs.validate.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Terraform Init
        working-directory: infrastructure/terraform/modules/customer-instance
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=instances/${{ needs.validate.outputs.instance_id }}/terraform.tfstate" \
            -backend-config="region=${{ secrets.AWS_REGION }}"

      - name: Terraform Plan
        working-directory: infrastructure/terraform/modules/customer-instance
        run: |
          terraform plan \
            -var="instance_id=${{ needs.validate.outputs.instance_id }}" \
            -var="customer_code=${{ needs.validate.outputs.customer_code }}" \
            -var="environment=${{ needs.validate.outputs.environment }}" \
            -var="resource_tier=${{ needs.validate.outputs.resource_tier }}" \
            -var="db_host=${{ secrets.DB_HOST }}" \
            -var="redis_host=${{ secrets.REDIS_HOST }}" \
            -out=tfplan

      - name: Upload plan
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: infrastructure/terraform/modules/customer-instance/tfplan

  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: [validate, terraform-plan]
    environment: ${{ needs.validate.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Download plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan
          path: infrastructure/terraform/modules/customer-instance

      - name: Terraform Init
        working-directory: infrastructure/terraform/modules/customer-instance
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=instances/${{ needs.validate.outputs.instance_id }}/terraform.tfstate" \
            -backend-config="region=${{ secrets.AWS_REGION }}"

      - name: Terraform Apply
        working-directory: infrastructure/terraform/modules/customer-instance
        run: terraform apply tfplan

      - name: Get Terraform outputs
        id: tf-outputs
        working-directory: infrastructure/terraform/modules/customer-instance
        run: |
          echo "namespace=$(terraform output -raw namespace)" >> $GITHUB_OUTPUT
          echo "database_name=$(terraform output -raw database_name)" >> $GITHUB_OUTPUT
          echo "s3_bucket=$(terraform output -raw s3_bucket_name)" >> $GITHUB_OUTPUT

  run-migrations:
    name: Run Instance Migrations
    runs-on: ubuntu-latest
    needs: [validate, terraform-apply]
    environment: ${{ needs.validate.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run instance migrations
        run: npm run migration:run:instance
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: instance_${{ needs.validate.outputs.customer_code }}

  deploy-services:
    name: Deploy Instance Services
    runs-on: ubuntu-latest
    needs: [validate, run-migrations]
    environment: ${{ needs.validate.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.28.0'

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.0'

      - name: Configure Kubernetes context
        uses: azure/k8s-set-context@v4
        with:
          kubeconfig: ${{ secrets.KUBE_CONFIG }}

      - name: Deploy instance services
        run: |
          NAMESPACE="hw-${{ needs.validate.outputs.customer_code }}"

          helm upgrade --install hubblewave-instance \
            ./infrastructure/helm/instance-services \
            --namespace $NAMESPACE \
            --set instanceId=${{ needs.validate.outputs.instance_id }} \
            --set customerCode=${{ needs.validate.outputs.customer_code }} \
            --set resourceTier=${{ needs.validate.outputs.resource_tier }} \
            --set environment=${{ needs.validate.outputs.environment }} \
            --set-string database.host=${{ secrets.DB_HOST }} \
            --set-string database.name=instance_${{ needs.validate.outputs.customer_code }} \
            --set-string redis.host=${{ secrets.REDIS_HOST }} \
            --values ./infrastructure/helm/instance-services/values-${{ needs.validate.outputs.environment }}.yaml \
            --wait --timeout 10m

  notify-control-plane:
    name: Notify Control Plane
    runs-on: ubuntu-latest
    needs: [validate, deploy-services]
    environment: ${{ needs.validate.outputs.environment }}
    steps:
      - name: Update instance status in Control Plane
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.CONTROL_PLANE_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "instanceId": "${{ needs.validate.outputs.instance_id }}",
              "status": "active",
              "provisionedAt": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"
            }' \
            "${{ secrets.CONTROL_PLANE_URL }}/api/internal/instances/status"
